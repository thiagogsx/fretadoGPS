<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innomotics - Passageiro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #1A1A1A; --brand-color: #E1F000; --card-bg: #2C2C2C; }
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; overflow: hidden; background: var(--bg-color); }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        .top-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 1000; }
        select {
            width: 100%; padding: 12px 20px; border-radius: 30px;
            border: 2px solid var(--brand-color); background-color: var(--card-bg);
            color: white; font-size: 0.9rem; font-weight: bold; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23E1F000'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); outline: none; text-overflow: ellipsis;
        }
        .info-card {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background-color: var(--card-bg); color: white;
            padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 4px solid #666; z-index: 1000; transition: border-color 0.3s;
        }
        .bus-info h2 { margin: 0; font-size: 1.2rem; }
        .bus-info p { margin: 5px 0 0; color: #aaa; font-size: 0.9rem; }
        .status-badge {
            background-color: #666; color: black; padding: 5px 10px;
            border-radius: 20px; font-weight: bold; font-size: 0.8rem; text-transform: uppercase;
            transition: background-color 0.3s;
        }
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; justify-content: center; align-items: center; z-index: 2000; color: var(--brand-color); font-weight: bold; transition: opacity 0.5s;
        }
        .bus-icon-marker { background: transparent; border: none; }
        .bus-svg { filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.5)); transition: transform 0.5s linear; }
        .online-border { border-color: var(--brand-color) !important; }
        .offline-border { border-color: #666 !important; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">CARREGANDO MAPA...</div>
    <div class="top-bar">
        <select id="lineSelector" onchange="mudarLinha()">
            <option value="linha2">Linha 2: São Paulo (Barra Funda)</option>
            <option value="linha1">Linha 1: Jundiaí/ Várzea/ Campo Limpo</option>
            <option value="linha3">Linha 3: Francisco Morato</option>
        </select>
    </div>
    <div id="map"></div>
    <div id="infoCard" class="info-card offline-border">
        <div class="bus-info">
            <h2 id="busTitle">Linha 2</h2>
            <p>Velocidade: <span id="speedVal" style="color:white; font-weight:bold;">0</span> km/h</p>
            <p style="font-size: 0.75rem; color: #777;">Atualizado há: <span id="lastUpdate">...</span>s</p>
        </div>
        <div id="statusBadge" class="status-badge">OFFLINE</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBFCEI_QYYWA7U4fEt0f6H0CYJMTVdVxlo",
          authDomain: "fretado-27e4a.firebaseapp.com",
          databaseURL: "https://fretado-27e4a-default-rtdb.firebaseio.com",
          projectId: "fretado-27e4a",
          storageBucket: "fretado-27e4a.firebasestorage.app",
          messagingSenderId: "886662004445",
          appId: "1:886662004445:web:b128a19293755d1082e534",
          measurementId: "G-7VJEQHDHJF"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Inicia mapa centralizado na rota
        const map = L.map('map', { zoomControl: false }).setView([-23.35, -46.80], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19
        }).addTo(map);

        const busSvgHtml = `<svg class="bus-svg" width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 16C4 16.88 4.39 17.67 5 18.22V20C5 20.55 5.45 21 6 21H7C7.55 21 8 20.55 8 20V19H16V20C16 20.55 16.45 21 17 21H18C18.55 21 19 20.55 19 20V18.22C19.61 17.67 20 16.88 20 16V6C20 2.5 16.42 2 12 2C7.58 2 4 2.5 4 6V16ZM7.5 17C6.67 17 6 16.33 6 15.5C6 14.67 6.67 14 7.5 14C8.33 14 9 14.67 9 15.5C9 16.33 8.33 17 7.5 17ZM16.5 17C15.67 17 15 16.33 15 15.5C15 14.67 15.67 14 16.5 14C17.33 14 18 14.67 18 15.5C18 16.33 17.33 17 16.5 17ZM5 6H19V11H5V6Z" fill="#E1F000"/></svg>`;
        const busIcon = L.divIcon({ className: 'bus-icon-marker', html: busSvgHtml, iconSize: [40, 40], iconAnchor: [20, 20] });
        
        // --- SEUS DADOS EXATOS DE ROTA ---
        const rotaBarraFundaGeoJSON = [
            [-46.666636, -23.524433, 730.5], [-46.666186, -23.524466, 730.5], [-46.665721, -23.524505, 729.25], [-46.665657, -23.524511, 729.25], [-46.66522, -23.524541, 728.75], [-46.665001, -23.524555, 728.5], [-46.664787, -23.52461, 728.25], [-46.664648, -23.524673, 728.25], [-46.664636, -23.52443, 728.75], [-46.664581, -23.522879, 729], [-46.664574, -23.522782, 729.25], [-46.664557, -23.522693, 729.5], [-46.664493, -23.522361, 730], [-46.664436, -23.522062, 730.25], [-46.664424, -23.522001, 730.25], [-46.664419, -23.521972, 730.25], [-46.664391, -23.52183, 730.25], [-46.664507, -23.521811, 730], [-46.66503, -23.521729, 728.75], [-46.665826, -23.521601, 728], [-46.666039, -23.52157, 727.75], [-46.666855, -23.52144, 727.25], [-46.666877, -23.521436, 727.25], [-46.666977, -23.521418, 727.5], [-46.66715, -23.521344, 728.25], [-46.667316, -23.521226, 729], [-46.667322, -23.521179, 729], [-46.667307, -23.521064, 729.25], [-46.667301, -23.520944, 729.5], [-46.667307, -23.520832, 730], [-46.667329, -23.520667, 729.75], [-46.66737, -23.520472, 729.5], [-46.667384, -23.52037, 729.25], [-46.667394, -23.520223, 729], [-46.667387, -23.520074, 728.75], [-46.667373, -23.519986, 728.5], [-46.667304, -23.519546, 727.25], [-46.667293, -23.519454, 727.25], [-46.667214, -23.518939, 727], [-46.667151, -23.518431, 727.5], [-46.667012, -23.517496, 727], [-46.666874, -23.516466, 727.75], [-46.666854, -23.516271, 727.75], [-46.666705, -23.515217, 727.75], [-46.666551, -23.514156, 728], [-46.666489, -23.513702, 728], [-46.666398, -23.513615, 728.25], [-46.666279, -23.513532, 728.25], [-46.666202, -23.513501, 728.25], [-46.666133, -23.513511, 728.25], [-46.666055, -23.51354, 728.25], [-46.665984, -23.513591, 728.25], [-46.665935, -23.51365, 728.25], [-46.665894, -23.513774, 728.25], [-46.665864, -23.513953, 728.5], [-46.66587, -23.51408, 728.75], [-46.66589, -23.514164, 728.75], [-46.666006, -23.51429, 728], [-46.666049, -23.514321, 728], [-46.666163, -23.514356, 727.5], [-46.666436, -23.514391, 726.5], [-46.666878, -23.514325, 725.75], [-46.668288, -23.514091, 727], [-46.668694, -23.514004, 727.25], [-46.668815, -23.513987, 727.5], [-46.669344, -23.513915, 727.75], [-46.669755, -23.513862, 728.25], [-46.67057, -23.513746, 728], [-46.670863, -23.513715, 728.25], [-46.671465, -23.513634, 733], [-46.671978, -23.513573, 733], [-46.672394, -23.513518, 731.25], [-46.672493, -23.513504, 730.75], [-46.672989, -23.513437, 728.75], [-46.673305, -23.513398, 727.25], [-46.673988, -23.513332, 728], [-46.675152, -23.513186, 726.25], [-46.675792, -23.513103, 729.5], [-46.676305, -23.513038, 729.25], [-46.677081, -23.512922, 727.5], [-46.677462, -23.512857, 726.25], [-46.678292, -23.512635, 724.75], [-46.678546, -23.51255, 723.75], [-46.678849, -23.512434, 722.75], [-46.679037, -23.512325, 722.25], [-46.679253, -23.512186, 722.25], [-46.679885, -23.511708, 722.25], [-46.680089, -23.511546, 722.5], [-46.680984, -23.510937, 727], [-46.681952, -23.510225, 727.25], [-46.682246, -23.510064, 726.75], [-46.682613, -23.509897, 726], [-46.682953, -23.509743, 725.5], [-46.683244, -23.509626, 725], [-46.683676, -23.509473, 725.75], [-46.683948, -23.509394, 726.5], [-46.684198, -23.509326, 726.75], [-46.684497, -23.509258, 726.25], [-46.685511, -23.509059, 724.5], [-46.68559, -23.509086, 724.25], [-46.686797, -23.508906, 722], [-46.687508, -23.508816, 722.5], [-46.68764, -23.50883, 722.75], [-46.688345, -23.508711, 725], [-46.689002, -23.508627, 721.5], [-46.689361, -23.508558, 720.75], [-46.689742, -23.508466, 721.75], [-46.690903, -23.508181, 724.5], [-46.691682, -23.508044, 728.25], [-46.691962, -23.508011, 726.5], [-46.692082, -23.508003, 725.75], [-46.694428, -23.507577, 724.5], [-46.694931, -23.5075, 724.75], [-46.695842, -23.507423, 725], [-46.696371, -23.507404, 724.5], [-46.696924, -23.507421, 725], [-46.697388, -23.507449, 726.5], [-46.698693, -23.507566, 726.5], [-46.699985, -23.507677, 731.75], [-46.701035, -23.50775, 726.25], [-46.703005, -23.507914, 724.25], [-46.704165, -23.508037, 724], [-46.705565, -23.508175, 724.75], [-46.706029, -23.508222, 725.5], [-46.706467, -23.508258, 724.5], [-46.707427, -23.50823, 723.25], [-46.708322, -23.50818, 724.25], [-46.709054, -23.508124, 724.25], [-46.710308, -23.508011, 725.25], [-46.710536, -23.507941, 724.75], [-46.710795, -23.507896, 724.5], [-46.711213, -23.507853, 724.75], [-46.711742, -23.507786, 725.25], [-46.71317, -23.507668, 723.25], [-46.713338, -23.507651, 722.5], [-46.713435, -23.507631, 722.25], [-46.713729, -23.507609, 722], [-46.714219, -23.507552, 721.75], [-46.714885, -23.507481, 723], [-46.715855, -23.507393, 724.5], [-46.716299, -23.507375, 725], [-46.716779, -23.50738, 725.5], [-46.717224, -23.507404, 726], [-46.717288, -23.507407, 726.25], [-46.717697, -23.507457, 727.75], [-46.718188, -23.507536, 729.75], [-46.718859, -23.507674, 732.75], [-46.719143, -23.507702, 733.75], [-46.719458, -23.507711, 735], [-46.719664, -23.507694, 736], [-46.719824, -23.507668, 736.5], [-46.720005, -23.507623, 737.5], [-46.720284, -23.507534, 737.5], [-46.720571, -23.507406, 740.25], [-46.720904, -23.507221, 744.75], [-46.721176, -23.507039, 746.5], [-46.721498, -23.506778, 747.75], [-46.721876, -23.506448, 746.75], [-46.721962, -23.506399, 746], [-46.722785, -23.505572, 744.5], [-46.724087, -23.504083, 750.5], [-46.724648, -23.503481, 754.25], [-46.727296, -23.500587, 764.75], [-46.727892, -23.499852, 763.25], [-46.728499, -23.499011, 765.25], [-46.728912, -23.498442, 763.5], [-46.729689, -23.49716, 762.25], [-46.729888, -23.496857, 761.75], [-46.730529, -23.495914, 764.25], [-46.731153, -23.494975, 759.5], [-46.73159, -23.4944, 759], [-46.732128, -23.493724, 761.75], [-46.733176, -23.492478, 762.75], [-46.735945, -23.489255, 774.5], [-46.736382, -23.488627, 778], [-46.736822, -23.487823, 783], [-46.737031, -23.487267, 785], [-46.737202, -23.48659, 783], [-46.737453, -23.484547, 777.75], [-46.737792, -23.482085, 768.5], [-46.737906, -23.481209, 771], [-46.738077, -23.480629, 775], [-46.738434, -23.479785, 775.5], [-46.738818, -23.479077, 770.75], [-46.739369, -23.47834, 769.75], [-46.739908, -23.47773, 777.5], [-46.740459, -23.477227, 780.25], [-46.741114, -23.47672, 777.75], [-46.741855, -23.476307, 775.5], [-46.743818, -23.475446, 770.25], [-46.744671, -23.475091, 766.5], [-46.745502, -23.474688, 763.25], [-46.745562, -23.474653, 763], [-46.746, -23.474395, 763.75], [-46.746447, -23.474078, 769.25], [-46.746813, -23.473766, 774], [-46.747258, -23.473297, 775], [-46.747558, -23.472888, 775.75], [-46.747867, -23.472379, 776.25], [-46.748108, -23.47186, 774.5], [-46.748857, -23.470103, 764.5], [-46.749502, -23.468641, 766.25], [-46.749954, -23.467591, 761.5], [-46.750172, -23.467085, 761.25], [-46.750464, -23.466433, 764.75], [-46.750705, -23.465895, 768.5], [-46.751208, -23.464788, 784.5], [-46.751344, -23.464469, 790], [-46.751786, -23.463391, 791.5], [-46.751941, -23.462888, 790], [-46.75205, -23.46248, 787.75], [-46.752157, -23.46201, 787], [-46.752956, -23.458124, 802], [-46.753267, -23.45657, 802], [-46.75357, -23.45512, 805.25], [-46.753831, -23.453868, 814], [-46.75393, -23.453429, 815], [-46.754487, -23.450663, 809], [-46.755126, -23.447313, 791], [-46.755738, -23.44467, 782], [-46.755986, -23.443481, 780.25], [-46.756173, -23.442624, 781], [-46.75634, -23.442004, 780.5], [-46.75652, -23.441521, 779.25], [-46.756789, -23.44086, 777.75], [-46.758061, -23.438291, 771.75], [-46.759568, -23.435195, 772.25], [-46.759868, -23.434428, 769.5], [-46.759969, -23.434171, 767.75], [-46.760039, -23.433831, 767.5], [-46.760144, -23.4332, 766.25], [-46.76021, -23.431866, 763.75], [-46.760229, -23.431507, 764.5], [-46.7604, -23.42895, 770], [-46.76058, -23.426025, 764.25], [-46.760669, -23.424809, 764.75], [-46.760733, -23.424053, 765.75], [-46.76079, -23.423504, 762.5], [-46.760967, -23.422776, 762.25], [-46.761431, -23.421752, 769], [-46.762187, -23.42043, 775.25], [-46.763917, -23.41746, 786.5], [-46.765395, -23.414892, 794], [-46.765679, -23.414353, 792.75], [-46.765953, -23.413765, 796.25], [-46.76625, -23.413192, 800.75], [-46.76641, -23.412774, 803], [-46.766666, -23.412041, 801.5], [-46.766922, -23.411223, 800.5], [-46.767134, -23.410399, 795], [-46.767288, -23.409636, 788], [-46.767401, -23.408889, 778.75], [-46.76749, -23.407992, 772.25], [-46.767531, -23.407323, 768], [-46.767519, -23.406728, 762.25], [-46.767532, -23.40611, 759.75], [-46.767642, -23.401197, 755], [-46.767683, -23.400334, 750.75], [-46.767701, -23.399985, 749.75], [-46.767838, -23.398722, 746.25], [-46.76792, -23.398181, 742.75], [-46.767963, -23.397776, 740], [-46.768043, -23.397235, 736.5], [-46.768123, -23.396483, 736.75], [-46.768516, -23.393228, 728.75], [-46.76878, -23.391157, 732.5], [-46.768929, -23.389717, 730.75], [-46.768936, -23.389438, 730.25], [-46.768939, -23.389315, 729.75], [-46.76901, -23.387631, 736.75], [-46.769063, -23.386695, 746.25], [-46.769164, -23.383775, 753.25], [-46.769287, -23.382854, 760.5], [-46.769496, -23.382002, 766.5], [-46.769802, -23.381165, 768.5], [-46.770226, -23.380392, 772.5], [-46.7708, -23.379585, 777.25], [-46.771583, -23.378772, 787], [-46.772597, -23.377911, 791.25], [-46.775569, -23.375478, 782.75], [-46.776328, -23.374831, 773.75], [-46.777331, -23.373939, 768.25], [-46.777744, -23.373476, 770.5], [-46.778047, -23.373105, 772], [-46.77835, -23.372676, 771.5], [-46.779334, -23.371032, 763.25], [-46.779546, -23.370675, 760.5], [-46.77989, -23.370116, 762], [-46.782411, -23.365861, 789.5], [-46.783208, -23.364504, 787.5], [-46.783468, -23.36399, 786.5], [-46.783605, -23.363652, 787.75], [-46.7838, -23.362997, 789.75], [-46.783937, -23.362369, 789.75], [-46.784165, -23.361153, 792], [-46.78424, -23.36083, 792.75], [-46.784361, -23.360424, 797.25], [-46.784482, -23.360097, 801], [-46.784675, -23.359686, 805.5], [-46.785152, -23.358868, 805], [-46.785308, -23.358651, 805.5], [-46.785502, -23.358404, 805.75], [-46.785986, -23.35794, 809.5], [-46.78645, -23.357583, 810.5], [-46.786847, -23.357322, 814], [-46.787035, -23.357216, 816.25], [-46.787827, -23.356858, 819.25], [-46.78832, -23.356679, 817.25], [-46.790417, -23.356182, 834], [-46.791187, -23.35594, 827.5], [-46.791525, -23.35581, 821.5], [-46.792032, -23.355566, 824.75], [-46.792271, -23.35543, 825.75], [-46.792502, -23.355273, 824.75], [-46.793016, -23.354886, 821.75], [-46.794028, -23.354022, 815.75], [-46.79432, -23.353722, 814], [-46.79509, -23.353133, 803.5], [-46.795978, -23.352549, 802.25], [-46.79657, -23.352217, 798.25], [-46.797026, -23.351983, 795.25], [-46.797938, -23.351603, 789.75], [-46.798284, -23.351473, 786.75], [-46.798571, -23.351377, 784.75], [-46.798866, -23.351308, 782.75], [-46.799218, -23.351239, 780.75], [-46.799883, -23.35112, 786.5], [-46.800244, -23.351088, 788], [-46.800594, -23.351042, 788.5], [-46.803145, -23.350773, 779], [-46.804828, -23.350576, 774], [-46.806525, -23.350395, 775.25], [-46.806961, -23.350318, 773.75], [-46.807308, -23.35024, 772.25], [-46.80775, -23.350127, 771], [-46.80859, -23.349862, 772.5], [-46.809242, -23.349612, 777.75], [-46.810006, -23.349225, 776], [-46.810937, -23.348621, 772.5], [-46.81138, -23.348263, 770], [-46.812418, -23.347317, 766], [-46.813466, -23.346345, 768.75], [-46.814361, -23.345485, 761.5], [-46.816027, -23.343841, 756.25], [-46.81691, -23.342975, 755.25], [-46.817858, -23.342124, 749.75], [-46.818198, -23.341795, 747], [-46.819345, -23.34071, 755], [-46.819723, -23.3403, 757.5], [-46.820057, -23.339924, 759.5], [-46.820394, -23.33949, 761.25], [-46.820746, -23.338998, 761], [-46.821338, -23.338071, 767.25], [-46.821557, -23.337664, 766.75], [-46.821913, -23.336929, 766.5], [-46.822218, -23.336152, 761.5], [-46.822434, -23.335485, 755.5], [-46.822546, -23.335101, 752], [-46.822663, -23.334609, 753.25], [-46.822768, -23.334052, 754.5], [-46.822851, -23.333445, 754.75], [-46.82291, -23.332986, 751], [-46.822993, -23.331722, 740.25], [-46.822986, -23.331461, 740.25], [-46.823017, -23.330386, 741.75], [-46.823087, -23.327703, 747.75], [-46.823162, -23.325747, 760.75], [-46.823183, -23.325044, 769.25], [-46.823196, -23.324512, 769.75], [-46.823209, -23.323936, 769.75], [-46.823216, -23.323664, 769.75], [-46.823222, -23.323391, 770], [-46.823235, -23.322986, 767.75], [-46.823236, -23.322954, 767.5], [-46.823238, -23.322886, 767.25], [-46.82324, -23.322815, 766.75], [-46.823243, -23.322696, 766], [-46.823248, -23.322517, 765], [-46.823251, -23.322335, 765], [-46.823299, -23.321026, 764.5], [-46.823325, -23.320034, 765], [-46.823362, -23.318885, 762.25], [-46.823387, -23.318018, 760.5], [-46.823413, -23.317379, 758.75], [-46.823427, -23.317008, 757.5], [-46.82345, -23.316658, 756.5], [-46.823486, -23.316362, 756], [-46.823544, -23.316031, 755.5], [-46.82362, -23.315706, 755.75], [-46.823708, -23.315408, 756.75], [-46.823834, -23.315099, 758.75], [-46.823979, -23.314784, 760.25], [-46.824143, -23.314497, 762], [-46.824322, -23.3142, 764.75], [-46.824581, -23.313812, 764], [-46.824939, -23.313386, 760.5], [-46.82518, -23.31313, 760], [-46.825441, -23.312893, 759], [-46.825701, -23.312681, 756.75], [-46.825994, -23.312477, 754.25], [-46.826275, -23.312304, 755.25], [-46.826601, -23.312127, 756.5], [-46.826911, -23.311984, 759.75], [-46.827238, -23.311854, 762.5], [-46.827591, -23.311723, 764.75], [-46.829374, -23.311078, 768], [-46.831101, -23.310462, 767.5], [-46.831712, -23.310244, 768.25], [-46.831966, -23.31015, 769.5], [-46.833209, -23.309573, 782.75], [-46.833513, -23.309387, 783.75], [-46.83387, -23.309141, 781.5], [-46.834062, -23.308996, 781.5], [-46.834424, -23.308705, 782.5], [-46.834689, -23.308469, 782.25], [-46.835409, -23.307751, 785], [-46.83621, -23.306919, 783.5], [-46.838711, -23.304384, 793.5], [-46.83931, -23.303737, 796], [-46.839617, -23.303367, 795.5], [-46.839956, -23.302882, 798.5], [-46.840198, -23.302455, 800.75], [-46.840331, -23.302155, 804.75], [-46.840442, -23.301849, 807.25], [-46.840543, -23.301514, 808.25], [-46.840602, -23.301232, 808.5], [-46.840711, -23.300514, 806.5], [-46.840814, -23.299533, 802], [-46.840846, -23.299255, 801], [-46.841, -23.297902, 813], [-46.841098, -23.296983, 819.25], [-46.84117, -23.296523, 820.25], [-46.841283, -23.29604, 819.5], [-46.841454, -23.295501, 820.75], [-46.841713, -23.294889, 825.25], [-46.841937, -23.294492, 833], [-46.842014, -23.294368, 834], [-46.842203, -23.294094, 833.75], [-46.84238, -23.293869, 833.5], [-46.842491, -23.293741, 832.25], [-46.842605, -23.293621, 834], [-46.842783, -23.293444, 834.25], [-46.84317, -23.293104, 831.25], [-46.843647, -23.292685, 831.75], [-46.845063, -23.291481, 830], [-46.845533, -23.291095, 830.5], [-46.845749, -23.290894, 827], [-46.845974, -23.290662, 827], [-46.846317, -23.290273, 828.75], [-46.846555, -23.289952, 828.25], [-46.846681, -23.289754, 830], [-46.846904, -23.289306, 833.5], [-46.847063, -23.288947, 833.5], [-46.847172, -23.288618, 833], [-46.84722, -23.288422, 832.75], [-46.847268, -23.288179, 831.25], [-46.847358, -23.287656, 828], [-46.847493, -23.286544, 823.25], [-46.8476, -23.285355, 830.25], [-46.847704, -23.284427, 841.25], [-46.847774, -23.283804, 845.75], [-46.848089, -23.281009, 828.75], [-46.848196, -23.280135, 822.5], [-46.848301, -23.279394, 817], [-46.848371, -23.278982, 814.25], [-46.848448, -23.278664, 811.5], [-46.848538, -23.278371, 809.5], [-46.848605, -23.278191, 810], [-46.84879, -23.277751, 812], [-46.848879, -23.277573, 812.75], [-46.849001, -23.277349, 815.75], [-46.849119, -23.277162, 818.25], [-46.849258, -23.276971, 819.25], [-46.84956, -23.276589, 819.25], [-46.849732, -23.276398, 819], [-46.849911, -23.276213, 817.25], [-46.850096, -23.276037, 815.25], [-46.851581, -23.274839, 805.75], [-46.852782, -23.273833, 797.75], [-46.853808, -23.273039, 796.5], [-46.854175, -23.272708, 799.5], [-46.85462, -23.272319, 798.25], [-46.854776, -23.272174, 798.75], [-46.854967, -23.271978, 798.75], [-46.855307, -23.271582, 799.25], [-46.855914, -23.270786, 793], [-46.856174, -23.2704, 788.5], [-46.857204, -23.268919, 782], [-46.857438, -23.268606, 782.5], [-46.857987, -23.268001, 781.5], [-46.858309, -23.267675, 780.5], [-46.858554, -23.267448, 780.25], [-46.858811, -23.26723, 780.5], [-46.859075, -23.267021, 780], [-46.859648, -23.266594, 779], [-46.859925, -23.266431, 780.25], [-46.860302, -23.266198, 781.5], [-46.860687, -23.26595, 780.25], [-46.863406, -23.264168, 772.5], [-46.864733, -23.263265, 765.75], [-46.865218, -23.262943, 765.25], [-46.865497, -23.262749, 765], [-46.865754, -23.262558, 764.75], [-46.865983, -23.262362, 764.5], [-46.866258, -23.262113, 764.25], [-46.866545, -23.261821, 764], [-46.866694, -23.261659, 763.75], [-46.866949, -23.261353, 764], [-46.867185, -23.26104, 764], [-46.867324, -23.260837, 764], [-46.86745, -23.260628, 766.75], [-46.867584, -23.260391, 770.25], [-46.867703, -23.260164, 773.5], [-46.867808, -23.259945, 776.75], [-46.867964, -23.259586, 781.75], [-46.869029, -23.256768, 781.75], [-46.869171, -23.25642, 782.25], [-46.869385, -23.255949, 783.25], [-46.869599, -23.255538, 786.25], [-46.869898, -23.255061, 791.5], [-46.870215, -23.254622, 793.25], [-46.870501, -23.254259, 791.5], [-46.87088, -23.253855, 794], [-46.871204, -23.253533, 795.25], [-46.871657, -23.253145, 795], [-46.875189, -23.250313, 780.75], [-46.876649, -23.249147, 770.25], [-46.87683, -23.248985, 768.75], [-46.877069, -23.248786, 767], [-46.877562, -23.248402, 764], [-46.877868, -23.248132, 762.5], [-46.87903, -23.246986, 754.5], [-46.88033, -23.245509, 765.75], [-46.881469, -23.244042, 771.75], [-46.882253, -23.243084, 782.75], [-46.883081, -23.242204, 784], [-46.883412, -23.24187, 780.75], [-46.886131, -23.239536, 760.75], [-46.887369, -23.238453, 760], [-46.888258, -23.2377, 767.75], [-46.891308, -23.235066, 795.25], [-46.891849, -23.234625, 797], [-46.893244, -23.233511, 795.25], [-46.893551, -23.233292, 795.5], [-46.897184, -23.230547, 813.75], [-46.898254, -23.22973, 812.25], [-46.898591, -23.229473, 811], [-46.90123, -23.227499, 833.75], [-46.906273, -23.223755, 838.5], [-46.907474, -23.222858, 835.25], [-46.911368, -23.219923, 808.5], [-46.911639, -23.219726, 806.5], [-46.913425, -23.218374, 800.5], [-46.919579, -23.21374, 771.75], [-46.920265, -23.213165, 768], [-46.920453, -23.212998, 768.25], [-46.920765, -23.212715, 768.75], [-46.921497, -23.211997, 765], [-46.922483, -23.210941, 771.25], [-46.923181, -23.21009, 771.75], [-46.923896, -23.209134, 782], [-46.924396, -23.20841, 791], [-46.924923, -23.207545, 786.75], [-46.925273, -23.206924, 787.25], [-46.925892, -23.205696, 789], [-46.926212, -23.204973, 786], [-46.926396, -23.204509, 782.25], [-46.926521, -23.204195, 780.25], [-46.92693, -23.203016, 769.25], [-46.927642, -23.200928, 769.75], [-46.928082, -23.199618, 767.75], [-46.928353, -23.198811, 769.75], [-46.930596, -23.192117, 768.75], [-46.931214, -23.190414, 761.5], [-46.931771, -23.188723, 757.5], [-46.932092, -23.187788, 753.25], [-46.932456, -23.186691, 747.25], [-46.932609, -23.186242, 747], [-46.932784, -23.185744, 746.75], [-46.933368, -23.18399, 746.25], [-46.934221, -23.181605, 740.5], [-46.935176, -23.178758, 736.75], [-46.935268, -23.17829, 736.5], [-46.935579, -23.177198, 738], [-46.935676, -23.176811, 737.5], [-46.935888, -23.176136, 737.5], [-46.936092, -23.175603, 739], [-46.93626, -23.175083, 740], [-46.936311, -23.174903, 739.75], [-46.936328, -23.174716, 739.5], [-46.936331, -23.174553, 739.5], [-46.936305, -23.174366, 740], [-46.936213, -23.174072, 741], [-46.936129, -23.173902, 741.5], [-46.936041, -23.173778, 741.75], [-46.935902, -23.173605, 741.75], [-46.935741, -23.173444, 741.75], [-46.93536, -23.173044, 736.75], [-46.935272, -23.172913, 735.5], [-46.935212, -23.17281, 734.25], [-46.935164, -23.172699, 733.25], [-46.935143, -23.172597, 732.5], [-46.935128, -23.17247, 731.25], [-46.935141, -23.172313, 729.75], [-46.93519, -23.17214, 730], [-46.935255, -23.172013, 728.75], [-46.935324, -23.171919, 728], [-46.935426, -23.171821, 727.5], [-46.935501, -23.171758, 727.5], [-46.935596, -23.171701, 727.5], [-46.935768, -23.171627, 728], [-46.935929, -23.171588, 728], [-46.936128, -23.171579, 727.5], [-46.936346, -23.171611, 727.5], [-46.936538, -23.171657, 727.25], [-46.936756, -23.171736, 726.75], [-46.937138, -23.171906, 725.75], [-46.937295, -23.171961, 725.5], [-46.937493, -23.172016, 725.25], [-46.937731, -23.172067, 724.25], [-46.937991, -23.172089, 723.25], [-46.938558, -23.172076, 720], [-46.939113, -23.171999, 715.75], [-46.940075, -23.171855, 708.5], [-46.941255, -23.171688, 703.75], [-46.941675, -23.171622, 702], [-46.942615, -23.171565, 696.75], [-46.943139, -23.171572, 696], [-46.943594, -23.171586, 695.75], [-46.944367, -23.171644, 695.5], [-46.944688, -23.171678, 695.25], [-46.945232, -23.171754, 694.75], [-46.94564, -23.171832, 694.5], [-46.946061, -23.171928, 695.25], [-46.946941, -23.172186, 699.75], [-46.947228, -23.172286, 701.25], [-46.948085, -23.172622, 704], [-46.948325, -23.172735, 705.5], [-46.948648, -23.172901, 706.75], [-46.949042, -23.173106, 706], [-46.949656, -23.173456, 704.5], [-46.949911, -23.173617, 703.75], [-46.950422, -23.173925, 702.25], [-46.951398, -23.174533, 699.75], [-46.954437, -23.176347, 709.5], [-46.954617, -23.176455, 711], [-46.956383, -23.177518, 721.5], [-46.957842, -23.178421, 733.75], [-46.958619, -23.178877, 736.5], [-46.959205, -23.17921, 739.25], [-46.959401, -23.179312, 741], [-46.960106, -23.179682, 746], [-46.960856, -23.180045, 747], [-46.961442, -23.18031, 744.75], [-46.962204, -23.180642, 736.5], [-46.962624, -23.180811, 730.5], [-46.96321, -23.181037, 727], [-46.963734, -23.181222, 722.75], [-46.964196, -23.181398, 719], [-46.965233, -23.181763, 725.75], [-46.967279, -23.182496, 744], [-46.967877, -23.182569, 748], [-46.96819, -23.18259, 749], [-46.968591, -23.182563, 748], [-46.969377, -23.182458, 745.25], [-46.969807, -23.18237, 746], [-46.969976, -23.182293, 746.25], [-46.970108, -23.182184, 745.5], [-46.970202, -23.182045, 745.25], [-46.970336, -23.181821, 745], [-46.970478, -23.18151, 745.25], [-46.970695, -23.181126, 744.75], [-46.970872, -23.180882, 743.5], [-46.97102, -23.180714, 742.75], [-46.971275, -23.18046, 741], [-46.971429, -23.18033, 739.5], [-46.971562, -23.180228, 738.25], [-46.971666, -23.180152, 737.25], [-46.971872, -23.180026, 735.5], [-46.972122, -23.179887, 733], [-46.972301, -23.179804, 731], [-46.972609, -23.179686, 727.75], [-46.975966, -23.178547, 711], [-46.97741, -23.178021, 719.25], [-46.978894, -23.177546, 726.75], [-46.980225, -23.177083, 735.25], [-46.981613, -23.17661, 742.75], [-46.981789, -23.176539, 743.75], [-46.984776, -23.175525, 748.25], [-46.986581, -23.174935, 732.75], [-46.988009, -23.174444, 737.25], [-46.989448, -23.173941, 747.75], [-46.989859, -23.173772, 750.25], [-46.990271, -23.173593, 752], [-46.991634, -23.17304, 750.5], [-46.99184, -23.17297, 750], [-46.991934, -23.172935, 749.75], [-46.992273, -23.172832, 749.75], [-46.992548, -23.172711, 750.25], [-46.992857, -23.172541, 750.75], [-46.993158, -23.172346, 751.75], [-46.99362, -23.172092, 752.5], [-46.993765, -23.171988, 752.75], [-46.993926, -23.171916, 753.25], [-46.993991, -23.171887, 753.25], [-46.994461, -23.171672, 754.75], [-46.994644, -23.171613, 755], [-46.994766, -23.171546, 755.25], [-46.994875, -23.171461, 755.5], [-46.994931, -23.171392, 755.5], [-46.994943, -23.171367, 755.5], [-46.994973, -23.171327, 755.75], [-46.995014, -23.171297, 755.75], [-46.995101, -23.17127, 755.5], [-46.995138, -23.171277, 755.25], [-46.995179, -23.171286, 755], [-46.995294, -23.171281, 754.75], [-46.995542, -23.171199, 754], [-46.996292, -23.170756, 752], [-46.997788, -23.169877, 742], [-46.999531, -23.169149, 722.75], [-46.999993, -23.168962, 717.25], [-47.000357, -23.16886, 717.25], [-47.001029, -23.168777, 719.25], [-47.001891, -23.168701, 725], [-47.001709, -23.167845, 720.25], [-47.001632, -23.167665, 718.75], [-47.001539, -23.167505, 717.5], [-47.00136, -23.167343, 716.5], [-47.001244, -23.167269, 716.25], [-47.001016, -23.167149, 716.25], [-47.000803, -23.16706, 716.75], [-47.000696, -23.166992, 717.5], [-47.000572, -23.16686, 719], [-47.000461, -23.166714, 720.25], [-47.000334, -23.166413, 722.5], [-47.000043, -23.164066, 738.25], [-47.000005, -23.164069, 738.25], [-46.999967, -23.164063, 738.75], [-46.999932, -23.164047, 739], [-46.999903, -23.164023, 739.5], [-46.999882, -23.163993, 739.75], [-46.999871, -23.163959, 740], [-46.999871, -23.163946, 740.25]
        ]; 

        // Função que corrige a inversão do GeoJSON (Inverte Lng, Lat para Lat, Lng)
        // Ignora a elevação (terceiro número)
        function corrigirRota(rotaGeoJson) {
            return rotaGeoJson.map(ponto => [ponto[1], ponto[0]]);
        }

        const rotasFixas = {
            "linha2": corrigirRota(rotaBarraFundaGeoJSON), // APLICA A CORREÇÃO AQUI
            "linha1": [ 
                [-23.1857, -46.8978], [-23.2100, -46.8300], [-23.2050, -46.7840]  
            ],
            "linha3": [ 
                [-23.1857, -46.8978], [-23.2820, -46.7450] 
            ]
        };
        
        let busMarker = null;
        let currentRef = null;
        let rotaPolyline = null; 
        let tracePolyline = null;
        let tracePath = []; 

        const statusBadge = document.getElementById('statusBadge');
        const infoCard = document.getElementById('infoCard');
        const speedVal = document.getElementById('speedVal');
        const lastUpdateVal = document.getElementById('lastUpdate');

        function mudarLinha() {
            const selector = document.getElementById('lineSelector');
            const novaLinhaId = selector.value;
            const nomeLinha = selector.options[selector.selectedIndex].text;
            document.getElementById('busTitle').innerText = nomeLinha.split(":")[0]; 

            if (currentRef) currentRef.off();
            if (busMarker) { map.removeLayer(busMarker); busMarker = null; }
            if (rotaPolyline) { map.removeLayer(rotaPolyline); rotaPolyline = null; }
            if (tracePolyline) { map.removeLayer(tracePolyline); tracePolyline = null; }
            tracePath = []; 

            if (rotasFixas[novaLinhaId]) {
                rotaPolyline = L.polyline(rotasFixas[novaLinhaId], {
                    color: 'gray', dashArray: '5, 10', weight: 4, opacity: 0.5
                }).addTo(map);
                map.fitBounds(rotaPolyline.getBounds(), {padding: [50, 50]});
            }

            tracePolyline = L.polyline([], {
                color: '#E1F000', weight: 5, opacity: 0.9
            }).addTo(map);
            
            setOffline();
            monitorarOnibus(novaLinhaId);
        }

        function setOffline() {
            statusBadge.textContent = "OFFLINE"; statusBadge.style.backgroundColor = "#666"; 
            infoCard.classList.remove('online-border'); infoCard.classList.add('offline-border');
            speedVal.textContent = "0";
        }
        function setOnline() {
            statusBadge.textContent = "ONLINE"; statusBadge.style.backgroundColor = "#E1F000"; 
            infoCard.classList.add('online-border'); infoCard.classList.remove('offline-border');
        }

        function monitorarOnibus(id) {
            currentRef = database.ref('frota/' + id);
            currentRef.on('value', (snapshot) => {
                document.getElementById('loading').style.opacity = 0;
                setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
                
                const data = snapshot.val();
                if (data && data.lat && data.lng) {
                    const lat = parseFloat(data.lat);
                    const lng = parseFloat(data.lng);
                    const speed = data.velocidade;
                    const secondsAgo = Math.floor((Date.now() - data.ultimaAtualizacao) / 1000);
                    
                    if (data.status === 'offline' || secondsAgo > 30) setOffline();
                    else setOnline();

                    const newLatLng = [lat, lng];
                    if (!busMarker) busMarker = L.marker(newLatLng, {icon: busIcon}).addTo(map);
                    else busMarker.setLatLng(newLatLng);
                    
                    if (secondsAgo <= 30) {
                        tracePath.push(newLatLng);
                        tracePolyline.setLatLngs(tracePath);
                    }
                    map.panTo(newLatLng); 
                    speedVal.innerText = speed;
                    lastUpdateVal.innerText = secondsAgo;
                } else setOffline();
            });
        }
        mudarLinha();
    </script>
</body>
</html>
